<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PICC Store Locator - Find Us Near You</title>

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
        }

        .store-locator-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .store-locator-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .store-locator-header h1 {
            color: #FFD700;
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .store-locator-header p {
            color: #888;
            font-size: 0.9rem;
        }

        .controls-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        #geocoder-container {
            flex: 1;
            min-width: 250px;
        }

        #geocoder-container .mapboxgl-ctrl-geocoder {
            width: 100%;
            max-width: none;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
        }

        #geocoder-container .mapboxgl-ctrl-geocoder input {
            color: #fff;
        }

        #geocoder-container .mapboxgl-ctrl-geocoder--suggestion {
            color: #fff;
        }

        .product-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #333;
            background: #1a1a1a;
            color: #888;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .filter-btn:hover {
            border-color: #FFD700;
            color: #FFD700;
        }

        .filter-btn.active {
            background: #FFD700;
            color: #000;
            border-color: #FFD700;
        }

        .map-and-list {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 16px;
            height: 600px;
        }

        @media (max-width: 768px) {
            .map-and-list {
                grid-template-columns: 1fr;
                height: auto;
            }

            .location-list {
                max-height: 300px;
                order: 2;
            }

            #map {
                height: 400px !important;
                order: 1;
            }
        }

        .location-list {
            background: #1a1a1a;
            border-radius: 12px;
            overflow-y: auto;
            padding: 8px;
        }

        .location-card {
            background: #222;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .location-card:hover {
            border-color: #FFD700;
        }

        .location-card.active {
            border-color: #FFD700;
            background: #2a2a1a;
        }

        .location-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .location-address {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .location-distance {
            color: #FFD700;
            font-size: 0.8rem;
        }

        .location-products {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .product-tag {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: #333;
            color: #FFD700;
            border-radius: 4px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            min-height: 400px;
        }

        .results-count {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .disclaimer {
            background: #1a1a1a;
            border-left: 3px solid #FFD700;
            padding: 12px 16px;
            margin-top: 16px;
            border-radius: 0 8px 8px 0;
            font-size: 0.8rem;
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        /* Mapbox popup styles */
        .mapboxgl-popup-content {
            background: #1a1a1a;
            color: #fff;
            border-radius: 8px;
            padding: 12px;
        }

        .mapboxgl-popup-close-button {
            color: #fff;
        }

        .popup-name {
            font-weight: 600;
            color: #FFD700;
            margin-bottom: 4px;
        }

        .popup-address {
            font-size: 0.85rem;
            color: #888;
        }

        .popup-directions {
            display: inline-block;
            margin-top: 8px;
            color: #FFD700;
            text-decoration: none;
            font-size: 0.85rem;
        }

        .popup-directions:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="store-locator-container">
        <div class="store-locator-header">
            <h1>Find Us Near You</h1>
            <p>Locate dispensaries carrying our products</p>
        </div>

        <div class="controls-row">
            <div id="geocoder-container"></div>
        </div>

        <div class="product-filter">
            <button class="filter-btn active" data-product="all">All Products</button>
            <button class="filter-btn" data-product="State of Mind">State of Mind</button>
            <button class="filter-btn" data-product="O-Yeah">O-Yeah</button>
            <button class="filter-btn" data-product="Sushi Hash">Sushi Hash</button>
            <button class="filter-btn" data-product="SMACK">SMACK</button>
            <button class="filter-btn" data-product="ICHI">ICHI-#JUAN</button>
        </div>

        <div class="results-count">
            <span id="results-count">0</span> locations found
        </div>

        <div class="map-and-list">
            <div class="location-list" id="location-list">
                <div class="loading">Loading stores...</div>
            </div>
            <div id="map"></div>
        </div>

        <div class="disclaimer">
            <strong>Note:</strong> Product availability may vary by location. Please call ahead to confirm stock before visiting.
        </div>
    </div>

    <script>
    (function() {
        // Configuration
        const CONFIG = {
            mapboxToken: 'pk.eyJ1IjoicGljYy1tYXBib3giLCJhIjoiY21qemx0eGZ4NnJ5NzNncTJraWMwdmVoNSJ9.TJ2Ikq3HsuyeqpsD_bM32g',
            sheetId: '1b6bHT52NrGvqjcul1T30JFpbXtXkVNCE7f5IZ3TDY5Q',
            sheetName: 'NY ProductDisplay Tracking Mirr',
            defaultCenter: [-74.0060, 40.7128], // NYC
            defaultZoom: 10,
            deliveryFilterDays: 60,
            cacheKey: 'picc_store_locator_cache',
            cacheExpiry: 6 * 60 * 60 * 1000 // 6 hours
        };

        // State
        let map = null;
        let markers = [];
        let allLocations = [];
        let filteredLocations = [];
        let selectedProduct = 'all';
        let userLocation = null;
        let geocoder = null;

        // Product column mapping
        const PRODUCT_COLUMNS = {
            'State of Mind': 'State of Mind 1G',
            'O-Yeah': 'O-Yeah 1G',
            'Sushi Hash': 'Sushi Hash 1G',
            'SMACK': 'SMACK 1G',
            'ICHI': 'ICHI- #JUAN 1G'
        };

        // Utility: Calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Utility: Format distance
        function formatDistance(miles) {
            if (miles < 0.1) return '< 0.1 mi';
            if (miles < 10) return miles.toFixed(1) + ' mi';
            return Math.round(miles) + ' mi';
        }

        // Fetch data from Google Sheets
        async function fetchSheetData() {
            // Check cache first
            const cached = localStorage.getItem(CONFIG.cacheKey);
            if (cached) {
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CONFIG.cacheExpiry) {
                        console.log('Using cached data');
                        return data;
                    }
                } catch (e) {
                    console.warn('Cache parse error, fetching fresh data');
                }
            }

            const url = `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(CONFIG.sheetName)}`;

            try {
                const response = await fetch(url);
                const text = await response.text();

                // Parse Google Sheets JSON response (wrapped in callback)
                const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
                if (!jsonStr) throw new Error('Invalid response format');

                const json = JSON.parse(jsonStr[1]);
                const rows = json.table.rows;
                const cols = json.table.cols;

                // Build header map
                const headers = {};
                cols.forEach((col, i) => {
                    if (col.label) headers[col.label] = i;
                });

                // Parse locations
                const locations = [];
                const sixtyDaysAgo = new Date(Date.now() - CONFIG.deliveryFilterDays * 24 * 60 * 60 * 1000);

                rows.forEach((row, idx) => {
                    const getValue = (colName) => {
                        const colIdx = headers[colName];
                        if (colIdx === undefined) return null;
                        const cell = row.c[colIdx];
                        return cell ? (cell.v || cell.f || null) : null;
                    };

                    const name = getValue('Dispensary Name');
                    const address = getValue('Address');
                    const lat = parseFloat(getValue('Lat'));
                    const lng = parseFloat(getValue('Lng'));
                    const status = getValue('Latest Order Status Above 1$');
                    const lastDeliveryStr = getValue('Last Order Delivered Date Above $1');

                    // Skip if missing required fields
                    if (!name || !address || isNaN(lat) || isNaN(lng)) return;

                    // Filter: must be delivered
                    const validStatuses = ['DELIVERED', 'DELIVERED_WITH_EDITS'];
                    if (!validStatuses.includes(status)) return;

                    // Filter: must be within 60 days
                    if (lastDeliveryStr) {
                        const lastDelivery = new Date(lastDeliveryStr);
                        if (lastDelivery < sixtyDaysAgo) return;
                    }

                    // Get products
                    const products = [];
                    Object.entries(PRODUCT_COLUMNS).forEach(([productName, colName]) => {
                        const val = getValue(colName);
                        if (val && val !== '' && val !== null) {
                            products.push(productName);
                        }
                    });

                    locations.push({
                        id: idx,
                        name,
                        address,
                        lat,
                        lng,
                        products,
                        lastDelivery: lastDeliveryStr
                    });
                });

                // Cache the data
                localStorage.setItem(CONFIG.cacheKey, JSON.stringify({
                    data: locations,
                    timestamp: Date.now()
                }));

                return locations;
            } catch (error) {
                console.error('Error fetching sheet data:', error);
                return [];
            }
        }

        // Initialize map
        function initMap() {
            mapboxgl.accessToken = CONFIG.mapboxToken;

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: CONFIG.defaultCenter,
                zoom: CONFIG.defaultZoom
            });

            map.addControl(new mapboxgl.NavigationControl(), 'top-right');

            // Initialize geocoder
            geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                marker: false,
                placeholder: 'Search by city, address, or ZIP',
                countries: 'us',
                bbox: [-80, 39, -71, 45] // NY region bounding box
            });

            document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

            geocoder.on('result', (e) => {
                userLocation = {
                    lat: e.result.center[1],
                    lng: e.result.center[0]
                };
                filterAndRender();
            });

            geocoder.on('clear', () => {
                userLocation = null;
                filterAndRender();
            });
        }

        // Create marker
        function createMarker(location) {
            const el = document.createElement('div');
            el.style.cssText = `
                width: 24px;
                height: 24px;
                background: #FFD700;
                border: 2px solid #000;
                border-radius: 50%;
                cursor: pointer;
            `;

            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                <div class="popup-name">${location.name}</div>
                <div class="popup-address">${location.address}</div>
                <a class="popup-directions" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location.address)}" target="_blank">
                    Get Directions
                </a>
            `);

            const marker = new mapboxgl.Marker(el)
                .setLngLat([location.lng, location.lat])
                .setPopup(popup)
                .addTo(map);

            el.addEventListener('click', () => {
                selectLocation(location);
            });

            return marker;
        }

        // Update markers
        function updateMarkers() {
            // Remove existing markers
            markers.forEach(m => m.remove());
            markers = [];

            // Add new markers
            filteredLocations.forEach(loc => {
                markers.push(createMarker(loc));
            });

            // Fit bounds if locations exist
            if (filteredLocations.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                filteredLocations.forEach(loc => bounds.extend([loc.lng, loc.lat]));
                if (userLocation) bounds.extend([userLocation.lng, userLocation.lat]);
                map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
            }
        }

        // Render location list
        function renderList() {
            const listEl = document.getElementById('location-list');
            const countEl = document.getElementById('results-count');

            countEl.textContent = filteredLocations.length;

            if (filteredLocations.length === 0) {
                listEl.innerHTML = '<div class="no-results">No stores found matching your criteria</div>';
                return;
            }

            listEl.innerHTML = filteredLocations.map(loc => `
                <div class="location-card" data-id="${loc.id}">
                    <div class="location-name">${loc.name}</div>
                    <div class="location-address">${loc.address}</div>
                    ${loc.distance ? `<div class="location-distance">${formatDistance(loc.distance)}</div>` : ''}
                    ${loc.products.length > 0 ? `
                        <div class="location-products">
                            ${loc.products.map(p => `<span class="product-tag">${p}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Add click handlers
            listEl.querySelectorAll('.location-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = parseInt(card.dataset.id);
                    const loc = filteredLocations.find(l => l.id === id);
                    if (loc) selectLocation(loc);
                });
            });
        }

        // Select location
        function selectLocation(location) {
            // Update active state
            document.querySelectorAll('.location-card').forEach(c => c.classList.remove('active'));
            const card = document.querySelector(`.location-card[data-id="${location.id}"]`);
            if (card) {
                card.classList.add('active');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Pan map
            map.flyTo({
                center: [location.lng, location.lat],
                zoom: 14
            });

            // Open popup
            const marker = markers.find(m => {
                const lngLat = m.getLngLat();
                return lngLat.lng === location.lng && lngLat.lat === location.lat;
            });
            if (marker) marker.togglePopup();
        }

        // Filter and render
        function filterAndRender() {
            // Apply product filter
            filteredLocations = allLocations.filter(loc => {
                if (selectedProduct === 'all') return true;
                return loc.products.some(p => p.includes(selectedProduct) || selectedProduct.includes(p));
            });

            // Calculate distances if user location set
            if (userLocation) {
                filteredLocations = filteredLocations.map(loc => ({
                    ...loc,
                    distance: calculateDistance(userLocation.lat, userLocation.lng, loc.lat, loc.lng)
                }));
                filteredLocations.sort((a, b) => a.distance - b.distance);
            }

            renderList();
            updateMarkers();
        }

        // Setup filter buttons
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedProduct = btn.dataset.product;
                    filterAndRender();
                });
            });
        }

        // Initialize
        async function init() {
            initMap();
            setupFilters();

            allLocations = await fetchSheetData();
            console.log(`Loaded ${allLocations.length} locations`);

            filterAndRender();
        }

        // Wait for DOM and Mapbox to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
